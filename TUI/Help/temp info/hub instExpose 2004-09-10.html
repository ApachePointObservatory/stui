<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>The expose command</title>
</head>
<body>

<H3>Contents</h3>
  <ul>
  <li><a href="#expose">Expose command reference</a>
  <li><a href="#path">Image path options</a>
  <li><a href="#keys">Keywords</a>
  <li>Instrument notes:
     <ul>
     <li><a href="#DIS">DIS additions</a>
     <li><a href="#GRIm">GRIm additions</a>
     </ul>
  <li><a href="#changes">Changes</a>
  </ul>

<i>2004-09-10</i>

<a name="expose">
<H2><a name="exposeGrim">grimExpose COMMAND [ARGS]</h2>
<H2><a name="exposeDis">disExpose COMMAND [ARGS]</h2>
<H2><a name="exposeEchelle">echelleExpose COMMAND [ARGS]</h2>

   <p>Start a sequence of exposures, or control an active sequence. 

   <p><b>COMMAND</b> is an exposure command or a control command. The control commands are:
     
     <dl>
       <dt><b>pause</b>
       <dd>pause sequence. Also pause active exposure, if the exposure can be paused (<a href="#note1">1</a>).
     </dl>

     <dl>
       <dt><b>resume</b>
       <dd>resume sequence and any paused exposure, if one exists.
     </dl>

     <dl>
       <dt><b>stop</b>
       <dd>immediately readout and save current exposure, if possible (<a href="#note1">1</a>). 
           <br>In any case, stop the sequence.
     </dl>

     <dl>
       <dt><b>abort</b>
       <dd>immediately stop and DISCARD current exposure, if possible (<a href="#note1">1</a>).
           <br>In any case, stop the sequence.
     </dl>

     <dl>
       <dt><b>setPath <a href="#path">PATH-OPTIONS</a></b>
       <dd>define or adjust the path for a given instrument and
       program. All these can be specified with an exposure command,
       but it can be more convenient or intuitive to specify them
       separately.
     </dl>

     <dl>
       <dt><b>getPath</b>
       <dd>generate the exposure path keywords for the given
       instrument and the caller's program.
     </dl>

     <dl>
       <dt><b>help</b>
       <dd>generate a synopsis of the expose commands.
     </dl>
     
     <br><i><a name="note1">Note 1:</i> Most of the instruments pay no attention to new
         commands while reading out. So if a pause/stop/abort command
         is sent to the instrument after readout has started, the
         command will be run after the exposure is done, when it will
         be meaningless. I may figure out a sensible way of dealing
         with this; in the meanwhile the <b>expose</b> command returns
         a warning after the instrument command fails.

   <p>The exposure commands are:

   <dl><dt><b>bias [n=N] [PATH-OPTIONS]</b>
       <dt><b>dark time=S [n=N] [PATH-OPTIONS]</b>
       <dt><b>flat time=S [n=N] [PATH-OPTIONS]</b>
       <dt><b>object time=S [n=N] [PATH-OPTIONS]</b>

       <dd><br>
       Take N exposures of the given type. If given, adjust or set the file name, number, or path
       to the given <a href="#path">PATH-OPTIONS</a>. The difference
       between a flat and an object exposure is only that the FITS IMAGETYP value is set differently.
   </dl>

<h3><a name="path">Path options</h3>

  Each user is logged in with a given observing program (e.g. PU04),
  and can control several instruments. At the same time, all users
  from the same program are likely collaborating, so the system is set
  up to remember and maintain a single directory and filename pattern
  for each program+instrument. In other words, for each instrument
  that a given program uses, the system remembers and maintains a
  single path.

  All parts of the path are 'sticky': once specified, any user from
  same program using the same instrument would later get the same
  values. Well, the sequence number would be incremented.
     

  <dl><dt><b>name=NAME</b>
      <dd>the directory and filename. This will
     be under an APO-specified root directory.  Absolute and relative
     paths are treated the same.  The APO root directory is currently
     /export/images/quarterPROGRAMNAME/UTYYMMDD on tycho.apo.nmsu.edu, where
     PROGRAMNAME is the assigned schedule (and login) ID. If there is no
     trailing period, one is silently added.
     <br>
     e.g. name="target1." or name="night1/target1." Default="test."

  </dl>

  <dl><dt><b>seq=N</b>
      <dd>the exposure number to start the sequence with. Besides a
      number, can be 'nextByDir', which gives the next highest number across
      <i>all</i> files in the current path's directory, or 'nextByFile',
      which gives the next highest number across the files matching the
      current path. Default='nextByDir'
  </dl>

  <dl><dt><b>startNum=N</b>
      <dd>the exposure number to <i>claim</i> the sequence starts
      with. This option is purely cosmetic, and only affects the
      content of the <i>inst</i>SeqState keyword.
  </dl>

  <dl><dt><b>totNum=N</b>
      <dd>the number of exposures to <i>claim</i> the sequence
      contains. This option is purely cosmetic, and only affects the
      content of the <i>inst</i>SeqState keyword.
  </dl>

  <dl><dt><b><a name="places">places=N</b>
      <dd>the number of digits to use for the sequence number. Default=4
  </dl>

  <dl><dt><b>suffix=TXT</b>
      <dd>how to finish the filename off. e.g. suffix='.fit'. Default='.fits'
          <i>This does not work with DIS yet.</i>
  </dl> 

  So if a PU04 user sent:<br>  

     <tt>    expose inst=echelle object time=10 n=2 name='flat.' seq=14 places=4</tt>
  <br>PU04 would get two files:<br>
     <tt>    tycho:/export/images/Q3PU04/UT040827/flat.0014.fit</tt> and <tt>tycho:/export/images/Q3PU04/UT040827/flat.0015.fit</tt>
  <br>And if another PU04 user then sent:<br>
     <tt>    expose inst=echelle bias name='tests/bias.'</tt>
  <br>that user would get:<br>
     <tt>    tycho:/export/images/Q3PU04/UT040827/tests/bias.0016.fit</tt>

<h2><a name="keys">Keywords</h2>

  In order to readily disambiguate which instrument's exposures are
  being described, the keywords all start with the canonical
  instrument name. <i>e.g. disNextPath, grimFiles, echelleExpState</i> Furthermore, the
  name of the sequence's program is always the first element of the
  keyword values.

  <dl>
    <dt><b><i>inst</i>NextPath=cmdrID,dir,name,number,suffix</b>
    <dd>The filename parts used to build the next filename. The
    directory is only the part under the program root. The number is a
    string with the number of digits that <b><a
    href="#places">places</a></b> specifies. The four parts
    may not be enough to build the final filename(s).
  </dl>

  <dl>
    <dt><a
    name="files"><b><i>inst</i>NewFiles=cmdrID,hostname,rootDir,programDir,userDir,filename1,...,filenameN</b>
    <dd><i>inst</i>NewFiles is generated when a new exposure has been
    started, and describes the files which are being created. There is
    usually just one filename; in cases when it can be more, and some
    file in the list is not generated, <tt>None</tt> will be used as a
    placeholder.

    <dt><a name="files"><b><i>inst</i>Files=cmdrID,hostname,rootDir,programDir,userDir,filename1,...,filenameN</b>
    <dd>If an exposure has finished, a list of the resulting
    filenames, and all the information required to get to them.
    There is usually just one filename; in cases when it can be
    more and some file in the list is not generated,
    an empty value will be used as a placeholder.

    <br>The pieces of the two keywords are:
    <dl><dt><b>cmdrID</b>
        <dd>The commander which started the exposure sequence.

	<dt><b>hostname</b>
	<dd>The full hostname where the files can be found.

	<dt><b>rootDir</b>
	<dd>The root directory on <b>hostname</b> under which all APO image files are
	currently saved.

	<dt><b>programDir</b>
	<dd>The directory under <b>rootDir</b> where all of the
	program's files are saved.

	<dt><b>userDir</b>
	<dd>The user-specified directory (under <b>programDir</b>)

	<dt><b>filename1,[...,filenameN]</b>
	<dd>The filename or filenames from the instrument.
    </dl>
    All of the directories are listed with trailing Unix '/'es, so
    the real filenames (for ftp or sftp's sake) can be found by
    concatenating <b>rootDir</b>, <b>programDir</b>, <b>userDir</b>,
    and the <b>filename</b>.

    <br><br>For example,
    <br>&nbsp;&nbsp<tt>disFiles="PU04.Ed","tycho.apo.nmsu.edu","/export/images/","Q3PU04/UT040827","",None,"bias.0006r.fits"</tt>
    <br>corresponds to:
    <br>&nbsp;&nbsp<tt>/export/images/Q3PU04/UT040827/bias.0006r.fits</tt> on <tt>tycho.apo.nmsu.edu</tt>

  </dl>

  <dl>
    <dt><b><i>inst</i>ExpState=cmdrID,state,timeStamp,expectedLength,timeLeft</b>
    <dd>Report on the current exposure. The fields are:
       <dl>
       <dt><b>cmdrID</b><dd>The scheduling program and the login name of the user which started the exposure sequence.
       <dt><b>state</b><dd>What the exposure is doing. Can currently be
       <b>idle</b>, <b>flushing</b>, <b>integrating</b>, <b>paused</b>,
       <b>reading</b>, <b>processing</b>, <b>done</b> or
       <b>aborted</b>.
       <dt><b>timeStamp</b><dd>The time when the current state started.
       <dt><b>expectedLength</b><dd>A best guess as to how long the current
       state will take, from start to finish. For <b>paused</b>, how much time is
       left in the exposure. Some states are deemed to be short enough
       that expectedLength will always be set to 0.
       <dt><b>timeLeft</b><dd>A best guess as to the time remaining in the
       current state.       
       </dl>
  </dl>

  <dl>
    <dt><b><i>inst</i>SeqState=cmdrID,type,reqTime,currentCount,totalCount,state</b>
    <dd>Report on the current exposure sequence.
       <dl>
       <dt><b>cmdrID</b><dd>The scheduling program and the login name of the user which started the exposure sequence.
       <dt><b>type</b><dd>The exposure type.
       <dt><b>reqTime</b><dd>The exposure time requested.
       <dt><b>currentCount</b><dd>Which exposure in the sequence is active.
       <dt><b>totalCount</b><dd>How many exposures were requested for this sequence.
       <dt><b>state</b><dd>What the sequence is doing. Can currently be
       <b>running</b>, <b>paused</b>, <b>aborted</b>, <b>stopped</b>
       or <b>done</b>.
       </dl>
  </dl>

  <dl>
    <dt><b>exposeTxt</b>
    <dd>Various reports of progress or trouble, intended to
    comfort or alarm the users. 
  </dl>

<h2>Instrument notes</h2>

<h3><a name="DIS">DIS notes</h3>

  DIS has two cameras. The command and keyword changes are that:
  <ul>
  <li>The <b>bias</b>, <b>dark</b>, <b>flat</b>, and <b>object</b> commands take
  <b>red</b> and <b>blue</b> options. If one of them is
  specified, only that camera will generate an image. If both or
  neither is specified, then both cameras will.
  <li>The <b><a href="#files">disFiles</a></b> keyword specifies the blue
  filename followed by the red filename.
  </ul>

<h3><a name="GRIm">GRIm notes</h3>

  GRIm cannot take biases, and exposures cannot be paused.

<h3><a name="changes">Changes</h3>

  <dl>
    <dt>2004-09-10
    <dd>Added the 'offset' and 'total' path options.
    <dd>Adjusted the 'seq' option description: 'nextByDir' is now the default.
  </dl>
  <dl>
    <dt>2004-09-08
    <dd>Added the 'nextByFile' and 'nextByDir' sequence number specifiers.
  </dl>
  <dl>
    <dt>2004-08-27
    <dd>Added <i>inst</i>Files.
  </dl>
  <dl>
    <dt>2003-10-06
    <dd>Normalized all keywords which specify user or program
    information to return the controlling commander ID
    (the program name plus the username) as their first element.
  </dl>
  <dl>
    <dt>2003-09-26
    <dd>Dropped <i>userDir</i> as part of a path specification. Any
    user-controlled  directories in a path are specified in the
    <b>name</b>. Merged the program and usernames in the
    <b>instSeqState</b> and <b>instExpState</b> keys.
  </dl>

</body>
</html>

