<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>The expose command</title>
</head>
<body>

<H3>Contents</h3>
  <ul>
	<li>Commands
	<ul>
		<li><a href="#expose"><i>inst</i>Expose</a>
		<li><a href="#pause">pause</a>
		<li><a href="#resume">resume</a>
		<li><a href="#stop">stop</a>
		<li><a href="#abort">abort</a>
		<li><a href="#setPath">setPath</a>
		<li><a href="#getPath">getPath</a>
		<li><a href="#help">help</a>
	</ul>
  <li><a href="#path">Image path options</a>
  <li><a href="#keys">Keywords</a>
	<ul>
		<li><a href="#files"><i>inst</i>Files</a>
		<li><a href="#newFiles"><i>inst</i>NewFiles</a>
		<li><a href="#nextPath"><i>inst</i>NextPath</a>
		<li><a href="#expState"><i>inst</i>ExpState</a>
		<li><a href="#seqState"><i>inst</i>SeqState</a>
		<li><a href="#comment">comment</a>
		<li><a href="#exposeTxt">exposeTxt</a>
	</ul>
  <li>Instrument notes:
     <ul>
     <li><a href="#DIS">DIS additions</a>
     <li><a href="#GRIm">GRIm additions</a>
     </ul>
  <li><a href="#changes">Changes</a>
  </ul>

<i>2004-10-04</i>

<H2><a name="expose"></a><i>inst</i>Expose COMMAND [ARGS]</h2>

   <p>Start a sequence of exposures, or control an active sequence. 

   <p><i>inst</i> must currently be one of: <tt>dis</tt>, <tt>grim</tt> or <tt>echelle</tt>.
   
   <p><b>COMMAND</b> is an exposure command or a control command.

<h3>The exposure commands are:</h3>

<dl>
	<dt><b><i>expType</i> time=sec [n=N] [<a href="#path">PATH-OPTIONS</a>] [startNum=N] [totNum=N] [comment=commentString]</b>
	
	<dd>Take one or more exposures, where:
	
	<dl>
		<dt><b>expType</b>
		<dd>One of: <code>bias</code>, <code>dark</code>, <code>flat</code> or <code>object</code>. The difference between a flat and an object exposure is only that the FITS IMAGETYP value is set differently. Warning: exposure time must not be specified for bias exposures.
		
		<dt><b>time=sec</b>
		<dd>The exposure time, in seconds. Omit for bias exposures. Required for all other types of exposures.
		
		<dt><b>n=N</b>
		<dd>The number of exposures. Defaults to 1.
		
		<dt><a href="#path">PATH-OPTIONS</a>
		<dd>may be used to specify the file directory, name or sequence number. (You may also use the <a href="#setPath">setPath</a> command to specify defaults for these values.)
		
		<dt><b>startNum=N</b>
		<dd>Starting number. This is used only for reporting sequence information in the <a href="#seqState"><i>inst</>SeqState</a> keyword, and is intended for scripts, where several batches of exposures may be combined to make one extended sequence.
		
		<dt><b>totNum=N</b>
		<dd>Total number of exposures. This is used only for reporting sequence information in the <i>inst</>SeqState keyword, and is intended for scripts, where several batches of exposures may be combined to make one extended sequence.
	</dl>

</dl>

   <h3>The control commands are:</h3>
 
     <dl>
       <dt><b><a name="pause"></a>pause</b>
       <dd>pause active exposure, if the exposure can be paused (<a href="#note1">1</a>).
     </dl>

     <dl>
       <dt><a name="resume"></a><b>resume</b>
       <dd>resume paused exposure, if one exists.
     </dl>

     <dl>
       <dt><a name="stop"></a><b>stop</b>
       <dd>immediately readout and save current exposure, if possible (<a href="#note1">1</a>). 
           <br>In any case, stop the sequence.
     </dl>

     <dl>
       <dt><a name="abort"></a><b>abort</b>
       <dd>immediately stop and DISCARD current exposure, if possible (<a href="#note1">1</a>).
           <br>In any case, stop the sequence.
     </dl>

     <dl>
       <dt><b><a name="setPath"></a>setPath <a href="#path">PATH-OPTIONS</a></b>
       <dd>define or adjust the path for a given instrument and
       program. All these can be specified with an exposure command,
       but it can be more convenient or intuitive to specify them
       separately.
     </dl>

     <dl>
       <dt><b><a name="getPath"></a>getPath</b>
       <dd>generate the exposure path keywords for the given
       instrument and the caller's program.
     </dl>

     <dl>
       <dt><b><a name="help"></a>help</b>
       <dd>generate a synopsis of the expose commands.
     </dl>
     
     <br><i><a name="note1">Note 1:</i> Most of the instruments pay no attention to new
         commands while reading out. So if a pause/stop/abort command
         is sent to the instrument after readout has started, the
         command will be run after the exposure is done, when it will
         be meaningless. I may figure out a sensible way of dealing
         with this; in the meanwhile the <b>expose</b> command returns
         a warning after the instrument command fails.

<h3><a name="path">Path options</h3>

	<p>Each user is logged in with a given observing program (e.g. PU04),
  and all users from a given program are assumed to be collaborating,
  so the system sets up a root directory for images based on the program name and observing date.
	<p>In addition, a user may want to use  different instruments,
  so the system can remember a different subdirectory and other path options
  for each instrument.

	<p>All parts of the path are 'sticky': once specified, any user from
  same program using the same instrument would later get the same
  values. Well, the sequence number would be incremented.

	<p><b>Warning:</b> if any collaborator specifies a directory in the
  <b>name</b>, then all others must also do so for the files to wind
  up in the same place.
<p><b>CRAIG:</b> how does this warning jive with the previous paragraph? I am confused.
     

  <dl><dt><b>name=NAME</b>
      <dd>the directory and filename. This will be under an APO-specified root directory.  Absolute and relative paths are treated the same. A period is appended to the name (if not already specified). The APO root directory is currently
    /export/images/<i>quarter</i><i>program</i>/<i>utdate</i> on tycho.apo.nmsu.edu, where:
<dl>
	<dt><i>quarter</i> is the quarter number, e.g. Q4
     <dt><i>program</i> is the program name, e.g. PU04
	<dt><i>utdate</i> is the UT date as UT<i>yymmdd</i>, e.g. UT041031 for 2004-10-31
</dl>

  </dl>

  <dl><dt><b>seq=N</b>
      <dd>the exposure number at which to start the sequence. Besides a number, can be 'nextByDir' (the default) or 'nextByFile'. 'nextByDir' yields a number one larger than any existing file in the directory (regardless of file name). 'nextByFile' yields a number one larger than any existing file with the same path and file name. Both flavors of 'next' start at 1.
  </dl>

  <dl><dt><b><a name="places">places=N</b>
      <dd>the number of digits to use for the sequence number. Default=4
  </dl>

  <dl><dt><b>suffix=TXT</b>
      <dd>how to finish the filename off. e.g. suffix='.fit'. Default='.fits'
          <i>This does not work with DIS yet.</i>
  </dl> 

  For example, if a PU04 user observing on 2004-10-31 sent the following command:<br>  

     <tt>    echelleExpose object time=10 n=2 name='night1/flat.' seq=14 places=4</tt>
  <br>PU04 would get two files:<br>
     <tt>    tycho:/export/images/Q4PU04/UT041031/night1/flat.0014.fit</tt> and <tt>...flat.0015.fit</tt>
  <br>And if another PU04 user then sent:<br>
     <tt>    echelleExpose bias name='night1/bias'</tt> (using the default seq='nextByDir' and automatic append of a period to the name),
  <br>that user would get:<br>
     <tt>    tycho:/export/images/Q4PU04/UT041031/night1/bias.0016.fit</tt>

<h2><a name="keys">Keywords</h2>

  In order to readily disambiguate which instrument's exposures are
  being described, most keywords start with the instrument name.
  <i>e.g. disNextPath, grimFiles, echelleExpState</i> Furthermore, the
  name of the sequence's program is always the first element of the
  keyword values.

  <dl>
    <dt><a name="files"></a><b><i>inst</i>Files=cmdrID,hostname,rootDir,programDir,userDir,filename1,...,filenameN</b>
    <dd>Output when an exposure has finished; provides a list of the resulting
    filenames, and all the information required to get to them.
    There is usually just one filename; in cases when it can be
    more, and some file in the list is not generated,
    <tt>None</tt> will be used as a placeholder.

    <br>The pieces of the keyword are:
    <dl><dt><b>cmdrID</b>
        <dd>The commander which started the exposure sequence.

	<dt><b>hostname</b>
	<dd>The full hostname where the files can be found.

	<dt><b>rootDir</b>
	<dd>The root directory on <b>hostname</b> under which all APO image files are
	currently saved.

	<dt><b>programDir</b>
	<dd>The directory under <b>rootDir</b> where all of the
	program's files are saved.

	<dt><b>userDir</b>
	<dd>The user-specified directory (under <b>programDir</b>).

	<dt><b>filename1,[...,filenameN]</b>
	<dd>The filename or filenames from the instrument.
    </dl>
    All of the directories are listed with trailing Unix '/'es, so
    the real filenames (for ftp or sftp's sake) can be found by
    concatenating <b>rootDir</b>, <b>programDir</b>, <b>userDir</b>,
    and the <b>filename</b>.

    <br><br>For example,
    <br>&nbsp;&nbsp<tt>disFiles="PU04.Ed","tycho.apo.nmsu.edu","/export/images/","1QPU04/UT041031/","night1/",None,"bias.0006r.fits"</tt>
    <br>corresponds to:
    <br>&nbsp;&nbsp<tt>/export/images/1QPU04/night1/bias.0006r.fits</tt> on <tt>tycho.apo.nmsu.edu</tt>

  </dl>

  <dl>
    <dt><a name="newFiles"></a><b><i>inst</i>NewFiles=cmdrID,hostname,rootDir,programDir,userDir,filename1,...,filenameN</b>
    <dd>A list of the files that will be saved at the end of the current exposure. The fields are the same as <a href="#files"><i>inst</i>Files</a>.
</dl>

  <dl>
    <dt><b><a name="nextPath"></a><i>inst</i>NextPath=cmdrID,userDir,name,number,suffix</b>
    <dd>The filename parts used to build the next filename. The
    directory is only the part under the program root. The number is a
    string with the number of digits that <b><a
    href="#places">places</a></b> specifies. The four parts
    may not be enough to build the final filename(s).
  </dl>

  <dl>
    <dt><b><a name="expState"><a/>expState<i>inst</i>ExpState=cmdrID,state,timeStamp,expectedLength,timeLeft</b>
    <dd>Report on the current exposure. The fields are:
       <dl>
       <dt><b>cmdrID</b><dd>The scheduling program and the login name of the user which started the exposure sequence.
       <dt><b>state</b><dd>What the exposure is doing. Can currently be
       <b>idle</b>, <b>flushing</b>, <b>integrating</b>, <b>paused</b>,
       <b>reading</b>, <b>processing</b>, <b>done</b> or
       <b>aborted</b>.
       <dt><b>timeStamp</b><dd>The time when the current state started.
       <dt><b>expectedLength</b><dd>A best guess as to how long the current
       state will take, from start to finish. For <b>paused</b>, how much time is
       left in the exposure. Some states are deemed to be short enough
       that expectedLength will always be set to 0.
       <dt><b>timeLeft</b><dd>A best guess as to the time remaining in the
       current state.       
       </dl>
  </dl>

  <dl>
    <dt><b><a name="seqState"></a><i>inst</i>SeqState=cmdrID,type,reqTime,currentCount,totalCount,state</b>
    <dd>Report on the current exposure sequence.
       <dl>
       <dt><b>cmdrID</b><dd>The scheduling program and the login name of the user which started the exposure sequence.
       <dt><b>type</b><dd>The exposure type.
       <dt><b>reqTime</b><dd>The exposure time requested.
       <dt><b>currentCount</b><dd>Which exposure in the sequence is active.
       <dt><b>totalCount</b><dd>How many exposures were requested for this sequence.
       <dt><b>state</b><dd>What the sequence is doing. Can currently be
       <b>running</b>, <b>paused</b>, <b>aborted</b>, <b>stopped</b>
       or <b>done</b>.
       </dl>
  </dl>

  <dl>
    <dt><b><a name="comment"></a>comment=commentString</b>
    <dd>User specified comment, if any.
  </dl>

  <dl>
    <dt><b><a name="exposeTxt"></a>exposeTxt</b>
    <dd>Various reports of progress or trouble, intended to
    comfort or alarm the users. 
  </dl>

<h2>Instrument notes</h2>

<h3><a name="DIS">DIS notes</h3>

  DIS has two cameras. The command and keyword changes are that:
  <ul>
  <li>The <b>bias</b>, <b>dark</b>, <b>flat</b>, and <b>object</b> commands take
  <b>red</b> and <b>blue</b> options. If one of them is
  specified, only that camera will generate an image. If both or
  neither is specified, then both cameras will.
  <li>The <b><a href="#files">disFiles</a></b> keyword specifies the blue
  filename followed by the red filename.
  </ul>

<h3><a name="GRIm">GRIm notes</h3>

  GRIm cannot take biases, and exposures cannot be paused.

<h3><a name="changes">Changes</h3>

  <dl>
    <dt>2004-10-04
    <dd>Changed expose inst=INSTNAME to <i>inst</i>Expose
  </dl>
  <dl>
    <dt>2003-10-06
    <dd>Normalized all keywords which specify user or program
    information to return the controlling commander ID
    (the program name plus the username) as their first element.
  </dl>
  <dl>
    <dt>2003-09-26
    <dd>Dropped <i>userDir</i> as part of a path specification. Any
    user-controlled  directories in a path are specified in the
    <b>name</b>. Merged the program and usernames in the
    <b>instSeqState</b> and <b>instExpState</b> keys.
  </dl>

</body>
</html>
